
















<!DOCTYPE html>
<html lang='en'><head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='https://stoneepigraph.github.io/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>postgresql-note - 石记</title>

    

    

    
    <meta name="author" content="Whatspeng!!!" />
    

    
        <meta property="og:url" content="https://stoneepigraph.github.io/posts/postgresql%E7%AC%94%E8%AE%B0/">
  <meta property="og:site_name" content="石记">
  <meta property="og:title" content="postgresql-note">
  <meta property="og:description" content="安装及配置 安装 下载postgresql https://www.postgresql.org/download/ 安装 按照官网的说明安装 su - postgres -c &#34;pg_ctl -D /var/lib/postgres/data -l /var/log/postgresql/postgresql.log start&#34; 切换到postgres用户修改postgres密码 su - postres alter user postgres with password &#39;passwod&#39; 备份及恢复 备份 pg_dump dbname &gt; dbname.bak # 备份单个数据库 pg_dumpall &gt; pd_backup.bak # 备份所有的数据库 备份格式有三种， 可以使用-F指定">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">

    

    
        
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="postgresql-note">
  <meta name="twitter:description" content="安装及配置 安装 下载postgresql https://www.postgresql.org/download/ 安装 按照官网的说明安装 su - postgres -c &#34;pg_ctl -D /var/lib/postgres/data -l /var/log/postgresql/postgresql.log start&#34; 切换到postgres用户修改postgres密码 su - postres alter user postgres with password &#39;passwod&#39; 备份及恢复 备份 pg_dump dbname &gt; dbname.bak # 备份单个数据库 pg_dumpall &gt; pd_backup.bak # 备份所有的数据库 备份格式有三种， 可以使用-F指定">

    <link rel="stylesheet" href="/style.min.d21d7ec2a4c5fdd1949f0c9ae34f92464a631f1e3f810acc268d854c8a7153dc798b0871ffbd2939035e2635fb78392227dcd96345321daffcbe0b3bffb9f612.css" integrity="sha512-0h1&#43;wqTF/dGUnwya40&#43;SRkpjHx4/gQrMJo2FTIpxU9x5iwhx/70pOQNeJjX7eDkiJ9zZY0UyHa/8vgs7/7n2Eg==">



    <link rel="stylesheet" href="/lib/css/prism.min.6226f06f992e0d6166b0e26724efd050dcc381202a752892ba523b1b865de2ea5e427f8f7d10de682fc35d6e7444018247d1f25db5e1e3bab17068ce191c5886.css" integrity="sha512-Yibwb5kuDWFmsOJnJO/QUNzDgSAqdSiSulI7G4Zd4upeQn&#43;PfRDeaC/DXW50RAGCR9HyXbXh47qxcGjOGRxYhg==">



    
    <script>
        if (!('theme' in localStorage)) {
            localStorage.theme = 'dark';
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.64a5d751579791aca02cca13ec10c056a8bb0de07cc69a70f0ef401bb0f470f2360e07f1f6f4398e0681f9abd2c64b3cb9d167ee471fa2a07bb1943e06e0c02b.js" integrity="sha512-ZKXXUVeXkaygLMoT7BDAVqi7DeB8xppw8O9AG7D0cPI2Dgfx9vQ5jgaB&#43;avSxks8udFn7kcfoqB7sZQ&#43;BuDAKw=="></script>



    <script defer src="/js/zooming.684b5d075bf94d0adfa21a7e7eb9acec1ddfb2e7b47d6657981617f0db0cf50949f1172801595afa3051f51b28d67f6a2d0c41be677b59b564307d9dbe4a4fd2.js" integrity="sha512-aEtdB1v5TQrfohp&#43;frms7B3fsue0fWZXmBYX8NsM9QlJ8RcoAVla&#43;jBR9Rso1n9qLQxBvmd7WbVkMH2dvkpP0g=="></script>







    
        

        
        
            
        

        
        
            
        

        <script defer src="/js/prism.bb99f69e9faa359f4337207a2aad8173e372376524468ed57aeab435f019eaaeced93189c044ca3906d06a0223239e0b62c6cd6ec88eb1489b5d688a2afb2ecd.js" integrity="sha512-u5n2np&#43;qNZ9DNyB6Kq2Bc&#43;NyN2UkRo7Veuq0NfAZ6q7O2TGJwETKOQbQagIjI54LYsbNbsiOsUibXWiKKvsuzQ==" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.0692b0cd56bdac7dd78b31e67c743db9e60288010c985f73f5f81ebbf225ce153c55216b43eb1482e61f084f40bc40d4d7f6a909c530a867c54d6d70be1b89ee.js" integrity="sha512-BpKwzVa9rH3XizHmfHQ9ueYCiAEMmF9z9fgeu/IlzhU8VSFrQ&#43;sUguYfCE9AvEDU1/apCcUwqGfFTW1wvhuJ7g=="></script>






    
</head>
<body><header>
    <div id="header_left">
        <div id="sidebar_btn">
            <input type="checkbox" id="sidebar_btn_input" class="hidden" />
            <label id="sidebar_btn_label" for="sidebar_btn_input">
                <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
</svg>

</svg>
            </label>
            <label id="sidebar_canvas_overlay_wrapper" for="sidebar_btn_input">
                <div id="sidebar_canvas_overlay"></div>
            </label>
            <div id="sidebar">
                <ul><li>
                            <a href="/posts/">posts</a></li><li>
                            <a href="/categories">Categories</a></li><li>
                            <a href="/tags">Tags</a></li><li>
                            <a href="/others/">Others</a></li><li>
                            <a href="/abouts">Abouts</a>
    <ul>
        

            
                <li>
                    
                        <a href="/abouts/about">About</a>
                    
                </li>
            
        

            
                <li>
                    
                        <a href="/abouts/contact">Contact</a>
                    
                </li>
            
        
    </ul>
</li></ul>
            </div>
        </div>
    
        <div class="brand">
            <div>
                <a href="/">石记</a>
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

</svg>
            <svg id="light_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>

</svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

</svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
</svg>

</svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
    </div>
</header>
<nav id="navbar" class="pure-menu">
    <ul class="pure-menu-list"><li class="navbar-item pure-menu-item insection">
                    
                        <a href="/posts/" class="pure-menu-link">posts</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/categories" class="pure-menu-link">Categories</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/tags" class="pure-menu-link">Tags</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/others/" class="pure-menu-link">Others</a>
                    
                </li><li class="navbar-item navbar-dropdown pure-menu-item pure-menu-has-children pure-menu-allow-hover ">
                    
                        <a href="/abouts" class="pure-menu-link">Abouts</a>
                    
                    <ul class="pure-menu-children">

    
        <li class="pure-menu-item">
            
                <a href="/abouts/about" class="pure-menu-link">About</a>
            
        </li>
    


    
        <li class="pure-menu-item">
            
                <a href="/abouts/contact" class="pure-menu-link">Contact</a>
            
        </li>
    

</ul>
                </li></ul>
</nav>
<main>
            <div id="content" class="content-margin">
                
    
    <div class="collapsible-menu-wrapper"><div class="collapsible-menu-type"><span>Table of contents</span></div><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#安装及配置">安装及配置</a>
      <ul>
        <li><a href="#安装">安装</a></li>
      </ul>
    </li>
    <li><a href="#备份及恢复">备份及恢复</a>
      <ul>
        <li><a href="#备份">备份</a></li>
        <li><a href="#恢复">恢复</a></li>
      </ul>
    </li>
    <li><a href="#序列">序列</a></li>
    <li><a href="#基础">基础</a>
      <ul>
        <li><a href="#函数">函数</a></li>
      </ul>
    </li>
    <li><a href="#索引">索引</a>
      <ul>
        <li><a href="#postgresql使用什么数据结构保存索引的-b-tree">postgresql使用什么数据结构保存索引的: B-tree</a></li>
      </ul>
    </li>
    <li><a href="#分区表">分区表</a>
      <ul>
        <li><a href="#创建分区表">创建分区表</a></li>
        <li><a href="#添加新的分区">添加新的分区</a></li>
      </ul>
    </li>
    <li><a href="#查询">查询</a>
      <ul>
        <li><a href="#慢sql">慢SQL</a></li>
        <li><a href="#查看锁">查看锁</a></li>
        <li><a href="#查询表结构">查询表结构</a></li>
      </ul>
    </li>
  </ul>
</nav>
        
    </div></div>



    <div class="content-margin">



<article class="line-numbers">
    
    
        
        
    
    
<h2 id="安装及配置" class="header-anchor-wrapper">安装及配置
  <a href="#%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>


<h3 id="安装" class="header-anchor-wrapper">安装
  <a href="#%e5%ae%89%e8%a3%85" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<ol>
<li>下载postgresql   <a href="https://www.postgresql.org/download/">https://www.postgresql.org/download/</a></li>
<li>安装 按照官网的说明安装
<pre  class="mc-prism hide language-text" ><code class="language-shell">su - postgres -c &quot;pg_ctl -D /var/lib/postgres/data -l /var/log/postgresql/postgresql.log start&quot;
</code></pre>
</li>
<li>切换到postgres用户修改postgres密码</li>
</ol>
<!--listend-->
<pre  class="mc-prism hide language-text" ><code class="language-shell">su - postres
alter user postgres with password 'passwod'
</code></pre>

<h2 id="备份及恢复" class="header-anchor-wrapper">备份及恢复
  <a href="#%e5%a4%87%e4%bb%bd%e5%8f%8a%e6%81%a2%e5%a4%8d" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>


<h3 id="备份" class="header-anchor-wrapper">备份
  <a href="#%e5%a4%87%e4%bb%bd" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<pre  class="mc-prism hide language-text" ><code class="language-shell">pg_dump dbname &gt; dbname.bak   # 备份单个数据库
pg_dumpall &gt; pd_backup.bak    # 备份所有的数据库
</code></pre>
<p>备份格式有三种， 可以使用-F指定</p>
<ol>
<li>*.bak 压缩二进制文件</li>
<li>*.sql 明文转储</li>
<li>*.tar tarball  t</li>
</ol>

<h3 id="恢复" class="header-anchor-wrapper">恢复
  <a href="#%e6%81%a2%e5%a4%8d" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<pre  class="mc-prism hide language-text" ><code class="language-shell">psql dbname &lt; dbanme.bak
pg_restore -U postgres -d dbname /tmp/back_filename.tar
</code></pre>

<h4 id="注意" class="header-anchor-wrapper">注意
  <a href="#%e6%b3%a8%e6%84%8f" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h4>

<p>使用psql恢复数据库需要先创建一个空的对应名称的数据库</p>

<h2 id="序列" class="header-anchor-wrapper">序列
  <a href="#%e5%ba%8f%e5%88%97" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<ol>
<li>查询序列的值
<pre  class="mc-prism hide language-text" ><code class="language-sql">select nextval('sys_menu_menu_id_seq');
</code></pre>
</li>
<li>修改序列的值从某个新值开始
<pre  class="mc-prism hide language-text" ><code class="language-sql">SELECT setval('bi_his_corp_policy_part_id_seq', (SELECT MAX(id) FROM bi_his_corp_policy));
</code></pre>
</li>
<li>修改序列
<pre  class="mc-prism hide language-text" ><code class="language-sql">         alter sequence sys_menu_menu_id_seq
increment by 1
    restart with 2354;
</code></pre>
</li>
</ol>

<h2 id="基础" class="header-anchor-wrapper">基础
  <a href="#%e5%9f%ba%e7%a1%80" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>


<h3 id="函数" class="header-anchor-wrapper">函数
  <a href="#%e5%87%bd%e6%95%b0" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>


<h4 id="创建函数" class="header-anchor-wrapper">创建函数
  <a href="#%e5%88%9b%e5%bb%ba%e5%87%bd%e6%95%b0" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h4>

<!--list-separator-->
<ul>
<li>exp insert
<pre  class="mc-prism hide language-text" ><code class="language-sql">create or replace function fun_date2utc(p_date timestamp) returns bigint
    language pluxsql
as
$$
declare
    utc integer;
begin
    utc = 86400 * (p_date - to_date('1970/01/01 00:00:00', 'YYYY/MM/DD HH24:MI:SS')) - 8*3600;
    return utc;
end;
$$;
create trigger trg_insert_local_vehicle2_dynamic
    before insert
    on bi_inf_vehicle_local
    for each row
execute procedure check_insert_dynamic_vehicle();
</code></pre>
</li>
</ul>
<!--list-separator-->
<ul>
<li>exp delete
<pre  class="mc-prism hide language-text" ><code class="language-sql">          create function check_delete_dynamic_vehicle() returns trigger
    language pluxsql
as
$$
begin
    delete from vd_sta_vehicle_local where vehicle_id = old.id;
    return old;
end;
$$;
alter function check_delete_dynamic_vehicle() owner to uxdb;
create trigger trg_delete_local_vehicle2_dynamic
      before delete
      on bi_inf_vehicle_local
      for each row
  execute procedure check_delete_dynamic_vehicle();
</code></pre>
</li>
</ul>

<h4 id="一些函数" class="header-anchor-wrapper">一些函数
  <a href="#%e4%b8%80%e4%ba%9b%e5%87%bd%e6%95%b0" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h4>

<!--list-separator-->
<ul>
<li>生成序列
<ul>
<li>generate_series()
<ul>
<li>生成数字序列
<pre  class="mc-prism hide language-text" ><code class="language-nil">select generate_series(1, 10)
</code></pre>
</li>
<li>生成时间序列</li>
</ul>
<!--listend-->
<pre  class="mc-prism hide language-text" ><code class="language-sql">select generate_series(now()::timestamp, now()::timestamp + interval '100 day', interval '1 day')
</code></pre>
</li>
</ul>
</li>
</ul>

<h2 id="索引" class="header-anchor-wrapper">索引
  <a href="#%e7%b4%a2%e5%bc%95" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>


<h3 id="postgresql使用什么数据结构保存索引的-b-tree" class="header-anchor-wrapper">postgresql使用什么数据结构保存索引的: B-tree
  <a href="#postgresql%e4%bd%bf%e7%94%a8%e4%bb%80%e4%b9%88%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e4%bf%9d%e5%ad%98%e7%b4%a2%e5%bc%95%e7%9a%84-b-tree" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>


<h2 id="分区表" class="header-anchor-wrapper">分区表
  <a href="#%e5%88%86%e5%8c%ba%e8%a1%a8" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>


<h3 id="创建分区表" class="header-anchor-wrapper">创建分区表
  <a href="#%e5%88%9b%e5%bb%ba%e5%88%86%e5%8c%ba%e8%a1%a8" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<p>创建分区表需要在表结构结束添加 partition by partition_type(partition_key);</p>
<ul>
<li>partition_type: 类型， 可以有range和list</li>
<li>partition_key: 分区字段，分区字段必须是主键或者是主键的一部分。</li>
</ul>
<!--listend-->
<pre  class="mc-prism hide language-text" ><code class="language-sql">          create table sa_sts_vehicle_day
(
    vehicle_id                   bigint                              not null,
    sts_time                     timestamp                           not null,
    days_online                  integer   default 0                 not null,
    constraint sa_sts_vehicle_day_new_pkey
        primary key (vehicle_id, sts_time)
)
    partition by RANGE (sts_time);
</code></pre>

<h3 id="添加新的分区" class="header-anchor-wrapper">添加新的分区
  <a href="#%e6%b7%bb%e5%8a%a0%e6%96%b0%e7%9a%84%e5%88%86%e5%8c%ba" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>


<h4 id="按时间生成分区表sql" class="header-anchor-wrapper">按时间生成分区表SQL
  <a href="#%e6%8c%89%e6%97%b6%e9%97%b4%e7%94%9f%e6%88%90%e5%88%86%e5%8c%ba%e8%a1%a8sql" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h4>

<pre  class="mc-prism hide language-text" ><code class="language-sql">      select 'create table vd_his_alarm_attachment_' || to_char(gen_date, 'yyyyMMdd') ||
   ' partition of vd_his_alarm_attachment_part for values from (''' || to_char(gen_date, 'yyyy-MM-dd HH24:mi:ss') ||
   ''') to (''' || to_char(gen_date + interval '1 day', 'yyyy-MM-dd HH24:mi:ss') || ''');' from (
select generate_series('2022-09-28'::date, '2023-12-31'::date, interval '1 day') gen_date) s
</code></pre>

<h4 id="添加新分区" class="header-anchor-wrapper">添加新分区
  <a href="#%e6%b7%bb%e5%8a%a0%e6%96%b0%e5%88%86%e5%8c%ba" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h4>

<pre  class="mc-prism hide language-text" ><code class="language-sql">create table sa_sts_vehicle_day_20231129 partition of sa_sts_vehicle_day for values from ('2023-11-29 00:00:00') to ('2023-11-30 00:00:00');
</code></pre>

<h2 id="查询" class="header-anchor-wrapper">查询
  <a href="#%e6%9f%a5%e8%af%a2" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>


<h3 id="慢sql" class="header-anchor-wrapper">慢SQL
  <a href="#%e6%85%a2sql" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<pre  class="mc-prism hide language-text" ><code class="language-sql">    -- 查看数据库执行的语句
    select pid, query_stay 执行时长s, REPLACE ( query, chr( 10 ), ' ' ) AS sql语句,
    datname 数据库, usename 用户, client_addr IP, application_name 应用,
    STATE 状态, backend_start 后台开始时间, xact_start 激活时间, xact_stay 激活时长s, query_start 开始执行时间
FROM (
         SELECT
             pgsa.pid AS pid, pgsa.datname AS datname, pgsa.usename AS usename, pgsa.client_addr client_addr,
             pgsa.application_name AS application_name, pgsa.STATE AS STATE, pgsa.backend_start AS backend_start,
             pgsa.xact_start AS xact_start, EXTRACT ( epoch FROM ( now( ) - pgsa.xact_start ) ) AS xact_stay,
             pgsa.query_start AS query_start, EXTRACT ( epoch FROM ( now( ) - pgsa.query_start ) ) AS query_stay,
             pgsa.query AS query
         FROM pg_stat_activity AS pgsa
         WHERE 1=1
           AND pgsa.STATE != 'idle'
           AND pgsa.STATE != 'idle in transaction'
           AND pgsa.STATE != 'idle in transaction (aborted)'
         --and (pgsa.query like 'drop %' or pgsa.query like 'DROP %')
     ) idleconnections
ORDER BY query_stay DESC;
      -- 删除进程
      SELECT pg_terminate_backend(7532);
</code></pre>

<h3 id="查看锁" class="header-anchor-wrapper">查看锁
  <a href="#%e6%9f%a5%e7%9c%8b%e9%94%81" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<pre  class="mc-prism hide language-text" ><code class="language-sql">          select w1.pid as 等待进程,
       w1.mode as 等待锁模式,
       w2.usename as 等待用户,
       w2.query as 等待会话,
       b1.pid as 锁的进程,
       b1.mode 锁的锁模式,
       b2.usename as 锁的用户,
       b2.query as 锁的会话,
       b2.application_name 锁的应用,
       b2.client_addr 锁的IP地址,
       b2.query_start 锁的语句执行时间
from pg_locks w1
         join pg_stat_activity w2 on w1.pid=w2.pid
         join pg_locks b1 on w1.transactionid=b1.transactionid and w1.pid!=b1.pid
         join pg_stat_activity b2 on b1.pid=b2.pid
where not w1.granted;
</code></pre>

<h3 id="查询表结构" class="header-anchor-wrapper">查询表结构
  <a href="#%e6%9f%a5%e8%af%a2%e8%a1%a8%e7%bb%93%e6%9e%84" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h3>

<pre  class="mc-prism hide language-text" ><code class="language-sql">select a.attnum AS &quot;序号&quot;,
       c.relname AS &quot;表名&quot;,
       cast(obj_description(relfilenode,'pg_class') as varchar) AS &quot;表名描述&quot;,
       a.attname AS &quot;列名&quot;,
       concat_ws('',t.typname,SUBSTRING(format_type(a.atttypid,a.atttypmod) from '\(.*\)')) as &quot;字段类型&quot;,
       d.description AS &quot;备注&quot;,
       a.attnotnull,
       a.atthasdef
from pg_class c, pg_attribute a , pg_type t, pg_description d
where  c.relname = 'bi_inf_vehicle_local'
  and a.attnum&gt;0
  and a.attrelid = c.oid
  and a.atttypid = t.oid
  and  d.objoid=a.attrelid
  and d.objsubid=a.attnum
ORDER BY c.relname DESC,a.attnum ASC ;
</code></pre>

</article>
</div>


                
                    
                
            </div>
        </main>
<footer>
    <article>Copyright © 2021-2023 by Whatspeng!!!</article>
</footer>

</body>
</html>
